metadata:
  id: 49320fd4-4abc-58d2-95cd-ec5c674015d4
  name: Ensure that Vulnerability Assessment (VA) is enabled on a SQL server by setting
    a Storage Account
  profile_applicability: '* Level 2'
  description: |-
    Enable Vulnerability Assessment (VA) service scans for critical SQL servers and corresponding SQL databases.
  rationale: |-
    Enabling Microsoft Defender for SQL server does not enables Vulnerability Assessment capability for individual SQL databases unless storage account is set to store the scanning data and reports.

    The Vulnerability Assessment service scans databases for known security vulnerabilities and highlights deviations from best practices, such as misconfigurations, excessive permissions, and unprotected sensitive data.

    Results of the scan include actionable steps to resolve each issue and provide customized remediation scripts where applicable.
    Additionally, an assessment report can be customized by setting an acceptable baseline for permission configurations, feature configurations, and database settings.
  audit: |-
    **From Azure Portal**

    1. Go to `SQL servers`
    2. Select a server instance
    3. Click on `Security Center`
    4. Ensure that `Microsoft Defender for SQL` is set to `Enabled`
    5. Select `Configure` next to `Enabled at subscription-level`
    6. In Section `Vulnerability Assessment Settings`, Ensure `Storage Accounts` does not read `Select Storage account` with no storage accounts listed under the `Storage account` heading.

    **From PowerShell**

    Get the list of all SQL Servers
    ```
    Get-AZSqlServer
    ```
    For each Server
    ```
    Get-AzSqlServerVulnerabilityAssessmentSetting -ResourceGroupName <resource group name> -ServerName <server name>
    ```
    Ensure that value for parameter `StorageAccountName` is not `empty` (blank).

    Sample Output:

    ```
    ResourceGroupName : ResourceGroup01

    ServerName : Server01

    StorageAccountName : mystorage

    ScanResultsContainerName : vulnerability-assessment

    RecurringScansInterval : None

    EmailSubscriptionAdmins : False

    NotificationEmail : {}
    ```
  remediation: |-
    **From Azure Portal**

    1. Go to `SQL servers`
    2. Select a server instance
    3. Click on `Security Center`
    4. Select `Configure` next to `Enabled at subscription-level`
    5. In Section `Vulnerability Assessment Settings`, Click `Select Storage account`
    6. Choose Storage Account (Existing or `Create New`). Click `Ok`
    7. Click `Save`

    **From PowerShell**

    If not already, Enable `Microsoft Defender for a SQL`: 
    ```
    Set-AZSqlServerThreatDetectionPolicy -ResourceGroupName <resource group name> -ServerName <server name> -EmailAdmins $True
    ```
    To enable ADS-VA service by setting Storage Account
    ```
    Update-AzSqlServerVulnerabilityAssessmentSetting `
     -ResourceGroupName "<resource group name>"`
     -ServerName "<Server Name>"`
     -StorageAccountName "<Storage Name from same subscription and same Location" `
     -ScanResultsContainerName "vulnerability-assessment" `
     -RecurringScansInterval Weekly `
     -EmailSubscriptionAdmins $true `
     -NotificationEmail @("mail1@mail.com" , "mail2@mail.com")
    ```
  impact: Enabling the `Microsoft Defender for SQL` features will incur additional
    costs for each SQL server.
  default_value: ''
  references: |-
    1. https://docs.microsoft.com/en-us/azure/sql-database/sql-vulnerability-assessment
    2. https://docs.microsoft.com/en-us/rest/api/sql/servervulnerabilityassessments/listbyserver
    3. https://docs.microsoft.com/en-in/powershell/module/Az.Sql/Update-AzSqlServerVulnerabilityAssessmentSetting?view=azps-2.6.0
    4. https://docs.microsoft.com/en-in/powershell/module/Az.Sql/Get-AzSqlServerVulnerabilityAssessmentSetting?view=azps-2.6.0
    5. https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-posture-vulnerability-management#pv-6-perform-software-vulnerability-assessments
  section: SQL Server - Microsoft Defender for SQL
  version: '1.0'
  tags:
  - CIS
  - AZURE
  - CIS 4.2.2
  - SQL Server - Microsoft Defender for SQL
  benchmark:
    name: CIS Microsoft Azure Foundations
    version: v2.0.0
    id: cis_azure
    rule_number: 4.2.2
    posture_type: cspm
