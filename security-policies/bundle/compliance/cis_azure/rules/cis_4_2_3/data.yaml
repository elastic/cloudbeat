metadata:
  id: a45dfded-5559-5d76-bbd1-f3e2132ec819
  name: |-
    Ensure that Vulnerability Assessment (VA) setting 'Periodic recurring scans' is set to 'on' for each SQL server
  profile_applicability: '* Level 2'
  description: |-
    Enable Vulnerability Assessment (VA) Periodic recurring scans for critical SQL servers and corresponding SQL databases.
  rationale: |-
    VA setting 'Periodic recurring scans' schedules periodic (weekly) vulnerability scanning for the SQL server and corresponding Databases.
    Periodic and regular vulnerability scanning provides risk visibility based on updated known vulnerability signatures and best practices.
  audit: |-
    **From Azure Portal**

    1. Go to `SQL servers`
    2. Select a server instance
    3. Click on `Security Center`
    4. Ensure that `Microsoft Defender for SQL` is set to `Enabled`
    5. In Section `Vulnerability Assessment Settings`, Ensure `Storage Accounts` is configured.
    6. In Section `Vulnerability Assessment Settings`, Ensure `Periodic recurring scans` is set to On.

    **From PowerShell**

    Get the list of all SQL Servers
    ```
    Get-AZSqlServer
    ```
    For each Server
    ```
    Get-AzSqlServerVulnerabilityAssessmentSetting -ResourceGroupName <resource group name> -ServerName <server name>
    ```
    Ensure that value for parameter `RecurringScansInterval` is not set to `None`.

    Sample Output:

    ```
    ResourceGroupName : ResourceGroup01

    ServerName : Server01

    StorageAccountName : mystorage

    ScanResultsContainerName : vulnerability-assessment

    RecurringScansInterval : weekly

    EmailSubscriptionAdmins : False

    NotificationEmail : {}
    ```
  remediation: |-
    **From Azure Portal**

    1. Go to `SQL servers`
    2. For each server instance
    3. Click on `Security Center`
    4. In Section `Vulnerability Assessment Settings`, set `Storage Account` if not already
    5. Toggle 'Periodic recurring scans' to ON.
    6. Click `Save`

    **From PowerShell**

    If not already, Enable `Advanced Data Security` for a SQL Server: 

    ```
    Set-AZSqlServerThreatDetectionPolicy -ResourceGroupName <resource group name> -ServerName <server name> -EmailAdmins $True
    ```
    To enable ADS-VA service with 'Periodic recurring scans'
    ```
    Update-AzSqlServerVulnerabilityAssessmentSetting `
     -ResourceGroupName "<resource group name>"`
     -ServerName "<Server Name>"`
     -StorageAccountName "<Storage Name from same subscription and same Location" `
     -ScanResultsContainerName "vulnerability-assessment" `
     -RecurringScansInterval Weekly `
     -EmailSubscriptionAdmins $true `
     -NotificationEmail @("mail1@mail.com" , "mail2@mail.com")
    ```
  impact: Enabling the `Azure Defender for SQL` feature will incur additional costs
    for each SQL server.
  default_value: ''
  references: |-
    1. https://docs.microsoft.com/en-us/azure/sql-database/sql-vulnerability-assessment
    2. https://docs.microsoft.com/en-us/rest/api/sql/servervulnerabilityassessments/listbyserver
    3. https://docs.microsoft.com/en-in/powershell/module/Az.Sql/Update-AzSqlServerVulnerabilityAssessmentSetting?view=azps-2.6.0
    4. https://docs.microsoft.com/en-in/powershell/module/Az.Sql/Get-AzSqlServerVulnerabilityAssessmentSetting?view=azps-2.6.0
    5. https://docs.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-posture-vulnerability-management#pv-6-perform-software-vulnerability-assessments
  section: SQL Server - Microsoft Defender for SQL
  version: '1.0'
  tags:
  - CIS
  - AZURE
  - CIS 4.2.3
  - SQL Server - Microsoft Defender for SQL
  benchmark:
    name: CIS Microsoft Azure Foundations
    version: v2.0.0
    id: cis_azure
    rule_number: 4.2.3
    posture_type: cspm
