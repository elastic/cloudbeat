{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "variables": {
        "userAssignedIdentityName": "[concat('ElasticCloudIdentity-', parameters('elasticCloudConnectorId'))]",
        "federatedIdentityCredentialsName": "[concat(variables('userAssignedIdentityName'), '/', 'fic-', uniqueString(resourceGroup().id))]",
        "customRoleDefinition": "[guid('ElasticCloudRoleDefinition-', parameters('elasticCloudConnectorId'))]",
        "customRoleDefinitionName": "[concat('Elastic Cloud Connector Role - ', parameters('elasticCloudConnectorId'))]",
        "customRoleAssignment": "[guid('ElasticCloudRoleAssignment-', parameters('elasticCloudConnectorId'))]",
        "securityReaderRoleAssignment": "[guid('ElasticCloudSecurityReaderRoleAssignment-', parameters('elasticCloudConnectorId'))]"
    },
    "parameters": {
        "elasticStackId": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Subject of the Federated Identity Credential token"
            }
        },
        "elasticCloudConnectorId": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Elastic Cloud Connector unique ID"
            }
        },
        "elasticCloudIssuer": {
            "type": "string",
            "defaultValue": "https://evgboidc-dpf8dmdjhnakhpgv.a02.azurefd.net/oidc/",
            "metadata": {
                "description": "Issuer for the Elastic Cloud Federated Identity Credential"
            }
        }
    },
    "resources": [
        {
            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
            "apiVersion": "2024-11-30",
            "name": "[variables('userAssignedIdentityName')]",
            "location": "[resourceGroup().location]",
            "tags": {
                "elastic-stack-id": "[parameters('elasticStackId')]",
                "elastic-cloud-connector-id": "[parameters('elasticCloudConnectorId')]"
            },
            "resources": [
                {
                    "type": "Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials",
                    "apiVersion": "2023-01-31",
                    "name": "[variables('federatedIdentityCredentialsName')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                    ],
                    "properties": {
                        "issuer": "[parameters('elasticCloudIssuer')]",
                        "subject": "[parameters('elasticStackId')]",
                        "audiences": [
                            "api://AzureADTokenExchange"
                        ]
                    }
                }
            ]
        },
        {
            "type": "Microsoft.Authorization/roleDefinitions",
            "apiVersion": "2022-04-01",
            "name": "[variables('customRoleDefinition')]",
            "properties": {
                "assignableScopes": [
                    "[concat('/subscriptions/', subscription().subscriptionId)]",
                    "[concat('/subscriptions/', subscription().subscriptionId, '/resourcegroups/', resourceGroup().name)]"
                ],
                "roleName": "[variables('customRoleDefinitionName')]",
                "description": "Provide Elastic Cloud Connector deployments with read permissions for web app configurations",
                "permissions": [
                    {
                        "actions": [
                            "Microsoft.Web/sites/*/read",
                            "Microsoft.Web/sites/config/Read",
                            "Microsoft.Web/sites/config/list/Action"
                        ]
                    }
                ],
                "type": "CustomRole"
            }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2022-04-01",
            "name": "[variables('customRoleAssignment')]",
            "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                "[variables('customRoleDefinition')]"
            ],
            "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('customRoleDefinition'))]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                "principalType": "ServicePrincipal"
            }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2022-04-01",
            "name": "[variables('securityReaderRoleAssignment')]",
            "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
            ],
            "properties": {
                "roleDefinitionId": "/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]",
                "principalType": "ServicePrincipal"
            }
        }
    ],
    "outputs": {
        "Identity": {
            "type": "string",
            "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
        },
        "PrincipalId": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').principalId]"
        },
        "ClientId": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2018-11-30').clientId]"
        },
        "TenantId": {
            "type": "string",
            "value": "[subscription().tenantId]"
        }
    }
}
