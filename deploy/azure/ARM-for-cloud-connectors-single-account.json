{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "variables": {
        "elasticCloudConnectorId": "[guid(subscription().subscriptionId, resourceGroup().id, deployment().name)]",
        "userAssignedIdentityName": "[concat('ElasticCloudIdentity-', variables('elasticCloudConnectorId'))]",
        "federatedIdentityCredentialsName": "[concat(variables('userAssignedIdentityName'), '/', 'fic-', uniqueString(resourceGroup().id))]",
        "customRoleDefinition": "[guid('ElasticCloudRoleDefinition-', variables('elasticCloudConnectorId'))]",
        "customRoleDefinitionName": "[concat('Elastic Cloud Connector Role - ', variables('elasticCloudConnectorId'))]",
        "roleAssignmentDeployment": "[concat('role-assignment-deployment-', resourceGroup().name)]"
    },
    "parameters": {
        "elasticStackId": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "Subject of the Federated Identity Credential token"
            }
        },
        "elasticCloudIssuer": {
            "type": "string",
            "defaultValue": "https://elastic-cloud-connector.s3.us-east-1.amazonaws.com",
            "metadata": {
                "description": "Issuer for the Elastic Cloud Federated Identity Credential"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location for all resources"
            }
        }
    },
    "resources": [
        {
            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
            "apiVersion": "2023-01-31",
            "name": "[variables('userAssignedIdentityName')]",
            "location": "[parameters('location')]",
            "tags": {
                "elastic-stack-id": "[parameters('elasticStackId')]",
                "elastic-cloud-connector-id": "[variables('elasticCloudConnectorId')]"
            },
            "resources": [
                {
                    "type": "Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials",
                    "apiVersion": "2023-01-31",
                    "name": "[variables('federatedIdentityCredentialsName')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
                    ],
                    "properties": {
                        "issuer": "[parameters('elasticCloudIssuer')]",
                        "subject": "[parameters('elasticStackId')]",
                        "audiences": [
                            "api://AzureADTokenExchange"
                        ]
                    }
                }
            ]
        },
        {
            "type": "Microsoft.Authorization/roleDefinitions",
            "apiVersion": "2022-04-01",
            "name": "[variables('customRoleDefinition')]",
            "properties": {
                "assignableScopes": [
                    "[concat('/subscriptions/', subscription().subscriptionId)]",
                    "[concat('/subscriptions/', subscription().subscriptionId, '/resourcegroups/', resourceGroup().name)]"
                ],
                "roleName": "[variables('customRoleDefinitionName')]",
                "description": "Provide Elastic Cloud Connector deployments with read permissions for web app configurations and additional Azure resources",
                "permissions": [
                    {
                        "actions": [
                            "Microsoft.Web/sites/*/read",
                            "Microsoft.Web/sites/config/Read",
                            "Microsoft.Web/sites/config/list/Action"
                        ]
                    }
                ],
                "type": "CustomRole"
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2023-07-01",
            "name": "[variables('roleAssignmentDeployment')]",
            "subscriptionId": "[subscription().subscriptionId]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
                "[variables('customRoleDefinition')]"
            ],
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                    "ResourceGroupName": {
                        "value": "[resourceGroup().name]"
                    },
                    "CustomRoleDefinitionId": {
                        "value": "[variables('customRoleDefinition')]"
                    },
                    "UserAssignedIdentityPrincipalId": {
                        "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2023-01-31').principalId]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "ResourceGroupName": {
                            "type": "string"
                        },
                        "CustomRoleDefinitionId": {
                            "type": "string"
                        },
                        "UserAssignedIdentityPrincipalId": {
                            "type": "string"
                        }
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Authorization/roleAssignments",
                            "apiVersion": "2022-04-01",
                            "name": "[guid(subscription().id, parameters('ResourceGroupName'), deployment().name, 'securityaudit')]",
                            "properties": {
                                "roleDefinitionId": "/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7",
                                "principalId": "[parameters('UserAssignedIdentityPrincipalId')]",
                                "principalType": "ServicePrincipal"
                            }
                        },
                        {
                            "type": "Microsoft.Authorization/roleAssignments",
                            "apiVersion": "2022-04-01",
                            "name": "[guid(subscription().id, parameters('ResourceGroupName'), deployment().name, 'additional-role')]",
                            "properties": {
                                "roleDefinitionId": "[concat('/providers/Microsoft.Authorization/roleDefinitions/', parameters('CustomRoleDefinitionId'))]",
                                "principalId": "[parameters('UserAssignedIdentityPrincipalId')]",
                                "principalType": "ServicePrincipal"
                            }
                        }
                    ]
                }
            }
        }
    ],
    "outputs": {
        "Identity": {
            "type": "string",
            "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
        },
        "PrincipalId": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2023-01-31').principalId]"
        },
        "ElasticCloudConnectorId": {
            "type": "string",
            "value": "[variables('elasticCloudConnectorId')]"
        },
        "ClientId": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2023-01-31').clientId]"
        },
        "TenantId": {
            "type": "string",
            "value": "[subscription().tenantId]"
        }
    }
}
