name: Destroy Environment
run-name: Destroying ${{ inputs.prefix }}* by @${{ github.actor }}

on:
  # Ability to execute on demand
  workflow_dispatch:
    inputs:
      prefix:
        type: string
        description: "Delete all environments starting with `prefix`"
        required: true
      ignore-prefix:
        type: string
        description: "Ignore all environments starting with `ignore-prefix`"
        required: false
      ec-api-key:
        type: string
        description: "**Optional** To delete env environments on your own organization, enter your Elastic Cloud API key."
        required: false
  workflow_call:
    inputs:
      prefix:
        type: string
        description: "Delete all environments starting with `prefix`"
        required: true
      ignore-prefix:
        type: string
        description: "Ignore all environments starting with `ignore-prefix`"
        required: false
      ec-api-key:
        type: string
        description: "**Optional** To delete env environments on your own organization, enter your Elastic Cloud API key."
        required: false

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: "eu-west-1"
  ENV_PREFIX: ${{ inputs.prefix }}
  ENV_IGNORE_PREFIX: ${{ inputs.ignore-prefix }}

jobs:
  Destroy:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    # Add "id-token" with the intended permissions.
    permissions:
      contents: "read"
      id-token: "write"
    steps:
      - name: Check out the repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4

      - name: Init Hermit
        run: ./bin/hermit env -r >> $GITHUB_ENV
        working-directory: ./

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@5fd3084fc36e372ff1fff382a39b10d03659f355 # v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Read ESS Region from Config
        id: read-ess-region
        shell: bash
        env:
          ENV_PREFIX: ${{ inputs.prefix }}
        run: |
          set +e
          # Find first environment with the prefix
          BUCKET="s3://tf-state-bucket-test-infra"
          FIRST_ENV=$(aws s3 ls "$BUCKET/$ENV_PREFIX" 2>/dev/null | awk '{print $2}' | sed 's/\///g' | head -n 1)

          if [ -z "$FIRST_ENV" ]; then
            echo "No environments found with prefix $ENV_PREFIX, defaulting to production-cft"
            echo "ess-region=production-cft" >> $GITHUB_OUTPUT
            echo "ESS_REGION_INPUT=production-cft" >> $GITHUB_ENV
          else
            # Download and read env_config.json
            if aws s3 cp "$BUCKET/$FIRST_ENV/env_config.json" /tmp/env_config.json 2>/dev/null; then
              ESS_REGION=$(jq -r '.ess_region // "production-cft"' /tmp/env_config.json)
              echo "ess-region=$ESS_REGION" >> $GITHUB_OUTPUT
              echo "ESS_REGION_INPUT=$ESS_REGION" >> $GITHUB_ENV
              echo "Read ess-region=$ESS_REGION from $FIRST_ENV/env_config.json"
              rm -f /tmp/env_config.json
            else
              echo "env_config.json not found for $FIRST_ENV, defaulting to production-cft"
              echo "ess-region=production-cft" >> $GITHUB_OUTPUT
              echo "ESS_REGION_INPUT=production-cft" >> $GITHUB_ENV
            fi
          fi
          set -e  # Re-enable error handling

      - name: Parse ESS Region Input
        id: parse-ess-region
        shell: bash
        working-directory: ./
        env:
          ESS_REGION_INPUT: ${{ steps.read-ess-region.outputs.ess-region || 'production-cft' }}
        run: |
          source .ci/scripts/parse_ess_region.sh

      - name: Determine Vault Path
        id: determine-vault-path
        if: inputs.ec-api-key == ''
        shell: bash
        working-directory: ./
        env:
          ENV_TYPE: ${{ env.ENV_TYPE }}
        run: |
          source .ci/scripts/determine_vault_path.sh
          echo "vault-path=$VAULT_PATH" >> $GITHUB_OUTPUT

      - name: Get Elastic Cloud Credentials from Vault
        id: get-ec-credentials
        if: inputs.ec-api-key == '' && steps.determine-vault-path.outcome == 'success'
        uses: hashicorp/vault-action@affa6f04da5c2d55e6e115b7d1b044a6b1af8c74 # v2.7.4
        continue-on-error: false
        with:
          url: ${{ secrets.VAULT_ADDR }}
          roleId: ${{ secrets.CSP_VAULT_ROLE_ID }}
          secretId: ${{ secrets.CSP_VAULT_SECRET_ID }}
          method: approle
          secrets: |
            ${{ steps.determine-vault-path.outputs.vault-path }} api_key | EC_API_KEY ;
            ${{ steps.determine-vault-path.outputs.vault-path }} url | EC_URL

      - name: Mask API Key
        if: ${{ inputs.ec-api-key != '' }}
        run: |
          ec_api_key=$(jq -r '.inputs["ec-api-key"]' $GITHUB_EVENT_PATH)
          echo "::add-mask::$ec_api_key"
          echo "TF_VAR_ec_api_key=$ec_api_key" >> $GITHUB_ENV
          echo "TF_VAR_ec_url=https://cloud.elastic.co" >> $GITHUB_ENV

      - name: Set Elastic Cloud Credentials
        id: set-ec-credentials
        shell: bash
        run: |
          # Priority: user-provided key (already set in Mask API Key step) > Vault key > production secret
          if [[ -n "${TF_VAR_ec_api_key:-}" ]]; then
            # User-provided key already set, ensure URL is set
            if [[ -z "${TF_VAR_ec_url:-}" ]]; then
              echo "TF_VAR_ec_url=https://cloud.elastic.co" >> $GITHUB_ENV
            fi
          elif [[ -n "${EC_API_KEY:-}" ]]; then
            # Use Vault credentials
            echo "TF_VAR_ec_api_key=$EC_API_KEY" >> $GITHUB_ENV
            echo "TF_VAR_ec_url=${EC_URL:-https://cloud.elastic.co}" >> $GITHUB_ENV
          else
            # Fall back to production secret
            echo "TF_VAR_ec_api_key=${{ secrets.EC_API_KEY }}" >> $GITHUB_ENV
            echo "TF_VAR_ec_url=https://cloud.elastic.co" >> $GITHUB_ENV
          fi

      - id: google-auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@140bb5113ffb6b65a7e9b937a81fa96cf5064462 # v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - id: azure-auth
        name: Azure login
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Destroy Environment
        run: |
          just delete-cloud-env "${ENV_PREFIX}" "${ENV_IGNORE_PREFIX}" "false"

      - name: Send Slack Notification
        uses: ./.github/actions/slack-notification
        if: always()
        continue-on-error: true
        env:
          RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          JOB_STATUS_COLOR: "${{ job.status == 'success' && '#36a64f' || '#D40E0D' }}"
          ESS_REGION: ${{ steps.read-ess-region.outputs.ess-region || 'production-cft' }}
        with:
          vault-url: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.CSP_VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.CSP_VAULT_SECRET_ID }}
          slack-payload: |
            {
              "text": "${{ github.workflow }} job <${{env.RUN_URL}}|${{ inputs.prefix }}> (ESS Region: ${{ env.ESS_REGION }}) triggered by `${{github.actor}}`",
            	"blocks": [
                {
                  "type": "divider"
                }
              ],
              "attachments": [
                {
                  "color": "${{ env.JOB_STATUS_COLOR }}",
                  "blocks": [
                    {
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": "${{ github.workflow }} job <${{env.RUN_URL}}|${{ inputs.prefix }}> (ESS Region: ${{ env.ESS_REGION }}) triggered by `${{github.actor}}`"
                        }
                    }
                  ]
                }
              ]
            }
